// localStorage ÌÇ§
const STORAGE_KEY = 'calendar_events';
const TODO_STORAGE_KEY = 'calendar_todos';

// Ïò§Îäò ÎÇ†Ïßú Î∞è ÌòÑÏû¨ ÌëúÏãú Ïõî ÏÑ§Ï†ï
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth();
const today = new Date();
const todayOnlyDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
let selectedDate = todayOnlyDate; // Í∏∞Î≥∏Í∞íÏùÄ Ïò§Îäò

// localStorage Ï†ÄÏû• Ìï®Ïàò
function saveEventsToStorage(events) {
    console.log('üíæ [Ï∫òÎ¶∞Îçî] Ïù¥Î≤§Ìä∏ Ï†ÄÏû•:', events.length, 'Í∞ú');
    localStorage.setItem(STORAGE_KEY, JSON.stringify(events));
}

function saveTodosToStorage(todos) {
    console.log('üíæ [Ï∫òÎ¶∞Îçî] TODO Ï†ÄÏû•:', todos.length, 'Í∞ú');
    localStorage.setItem(TODO_STORAGE_KEY, JSON.stringify(todos));
}

// localStorage Î°úÎìú Ìï®Ïàò
function loadEventsFromStorage() {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (stored) {
        const parsed = JSON.parse(stored);
        return parsed.map(event => ({
            ...event,
            date: new Date(event.date)
        }));
    }
    return getDefaultEvents();
}

function loadTodosFromStorage() {
    const stored = localStorage.getItem(TODO_STORAGE_KEY);
    if (stored) {
        const parsed = JSON.parse(stored);
        return parsed.map(todo => ({
            ...todo,
            date: new Date(todo.date)
        }));
    }
    return [];
}

// Í∏∞Î≥∏ Ïù¥Î≤§Ìä∏ Îç∞Ïù¥ÌÑ∞
function getDefaultEvents() {
    return [
        { date: new Date(currentYear, 9, 9), title: "AI Î™®Îç∏ ÏóÖÎç∞Ïù¥Ìä∏ Í≤ÄÌÜ†", type: "important" }, 
        { date: new Date(currentYear, 9, 9), title: "ÌåÄ Ï†êÏã¨ ÌöåÏãù ÏòàÏïΩ", type: "meeting" },
        { date: new Date(currentYear, 9, 9), title: "Í∞úÏù∏ ÌïôÏäµ ÏãúÍ∞Ñ", type: "personal" }, 
        { date: new Date(currentYear, 9, 9), title: "Ï∞®Í∏∞ ÌîÑÎ°úÏ†ùÌä∏ ÌöåÏùò Ï§ÄÎπÑ", type: "personal" }, 
        { date: new Date(currentYear, 9, 9), title: "Ï≤≠Íµ¨ÏÑú Ï†úÏ∂ú", type: "personal" }, 
        { date: new Date(currentYear, 9, 9), title: "Ïû•ÎπÑ Ï£ºÎ¨∏ Î∞è ÌôïÏù∏", type: "personal" }, 
        { date: new Date(currentYear, 9, 9), title: "Ï£ºÍ∞Ñ ÏÑ±Í≥º Ï†ïÎ¶¨", type: "personal" },
        { date: new Date(currentYear, 9, 10), title: "Ï£ºÍ∞Ñ ÏóÖÎ¨¥ Î≥¥Í≥† ÌöåÏùò", type: "meeting" },
        { date: new Date(currentYear, 9, 10), title: "ÏÉàÎ°úÏö¥ ÌîÑÎ°úÏ†ùÌä∏ Í∏∞Ìöç", type: "important" },
        { date: new Date(currentYear, 9, 11), title: "Ïù∏ÏÇ¨ÌåÄ Î©¥Ï†ë ÏùºÏ†ï", type: "meeting" },
        { date: new Date(currentYear, 9, 12), title: "Î≥¥Í≥†ÏÑú ÏµúÏ¢Ö Í≤ÄÌÜ† ÎßàÍ∞ê", type: "important" },
        { date: new Date(currentYear, 9, 12), title: "Ï£ºÎßê Í≥ÑÌöç Ï†ïÎ¶¨", type: "personal" },
        { date: new Date(currentYear, 9, 13), title: "Í∞úÎ∞úÌåÄ Ï†ïÍ∏∞ Ï£ºÍ∞ÑÌöåÏùò", type: "meeting" },
        { date: new Date(currentYear, 9, 13), title: "ÎßàÏºÄÌåÖ Ï†ÑÎûµ ÌöåÏùò", type: "meeting" },
    ];
}

// localStorageÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
let events = loadEventsFromStorage();
let todos = loadTodosFromStorage();
window.todos = todos; // ‚úÖ Ï†ÑÏó≠ Ï†ëÍ∑º Í∞ÄÎä•ÌïòÍ≤å

// localStorageÍ∞Ä ÎπÑÏñ¥ÏûàÏùÑ ÎïåÎßå ÏãúÎìú Îç∞Ïù¥ÌÑ∞
if (events.length === 0) {
    events = getDefaultEvents();
    saveEventsToStorage(events);
}

console.log('üìå [Ï∫òÎ¶∞Îçî] Ï¥àÍ∏∞ Î°úÎìú - Ïù¥Î≤§Ìä∏:', events.length, 'TODO:', todos.length);

// HTML ÏöîÏÜå Í∞ÄÏ†∏Ïò§Í∏∞
function initCalendar() {
    const calendarGrid = document.getElementById('calendarGrid');
    const currentMonthYear = document.getElementById('currentMonthYear');
    const prevMonthBtn = document.getElementById('prevMonthBtn');
    const nextMonthBtn = document.getElementById('nextMonthBtn');
    const dailyEventsList = document.getElementById('dailyEventsList');
    const dailyEventsTitle = document.getElementById('dailyEventsTitle');
    const dailyEventsContent = document.getElementById('dailyEventsContent');
    const meetingListEl = document.getElementById('meetingList');
    const meetingCardTitleContentEl = document.getElementById('meetingCardTitleContent');
    const meetingCountEl = document.getElementById('meetingCount');
    const todoListEl = document.getElementById('todoList');
    const todoInput = document.getElementById('todoInput');
    const addTodoBtn = document.getElementById('addTodoBtn');
    const todoCardTitleContentEl = document.getElementById('todoCardTitleContent');
    const todoCountEl = document.getElementById('todoCount');

    if (!calendarGrid || !currentMonthYear) {
        console.warn('Ï∫òÎ¶∞Îçî ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
        return;
    }

    const dayNames = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'];

    function formatMonthYear(year, monthIndex) {
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        return `${monthNames[monthIndex]} ${year}`;
    }

    function formatDateString(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function getEventsForDate(date) {
        const dateString = formatDateString(date);
        return events.filter(event => {
            const eventDateString = formatDateString(event.date);
            return eventDateString === dateString;
        });
    }

    function createEventDots(dayEvents) {
        const dotsContainer = document.createElement('div');
        dotsContainer.className = 'event-dots';
        
        const uniqueTypes = [...new Set(dayEvents.map(e => e.type))];
        
        uniqueTypes.forEach(type => {
            const dot = document.createElement('span');
            dot.className = `event-dot event-type-${type}`;
            dotsContainer.appendChild(dot);
        });
        
        return dotsContainer;
    }

    function renderCalendar() {
        calendarGrid.innerHTML = '';
        
        currentMonthYear.textContent = formatMonthYear(currentYear, currentMonth);

        dayNames.forEach(day => {
            const dayLabel = document.createElement('div');
            dayLabel.className = 'calendar-day-label';
            dayLabel.textContent = day;
            calendarGrid.appendChild(dayLabel);
        });

        const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const daysInPrevMonth = new Date(currentYear, currentMonth, 0).getDate();

        for (let i = 0; i < firstDayOfMonth; i++) {
            const dayCell = document.createElement('div');
            dayCell.className = 'calendar-day-cell other-month';
            const dayNumber = document.createElement('span');
            dayNumber.className = 'day-number';
            dayNumber.textContent = daysInPrevMonth - firstDayOfMonth + 1 + i;
            dayCell.appendChild(dayNumber);
            calendarGrid.appendChild(dayCell);
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(currentYear, currentMonth, day);
            const dayCell = document.createElement('div');
            dayCell.className = 'calendar-day-cell';
            dayCell.dataset.date = formatDateString(date);
            
            if (formatDateString(date) === formatDateString(todayOnlyDate)) {
                dayCell.classList.add('today');
            }

            const dayNumber = document.createElement('span');
            dayNumber.className = 'day-number';
            dayNumber.textContent = day;
            dayCell.appendChild(dayNumber);

            const dayEvents = getEventsForDate(date);
            if (dayEvents.length > 0) {
                const eventDots = createEventDots(dayEvents);
                dayCell.appendChild(eventDots);
            }

            dayCell.addEventListener('click', () => {
                selectDay(dayCell.dataset.date);
            });

            calendarGrid.appendChild(dayCell);
        }
        
        // Îã§Ïùå Îã¨ ÎÇ†Ïßú Ï±ÑÏö∞Í∏∞
        const totalCells = calendarGrid.children.length;
        const remainingCells = 7 - ((totalCells - 7) % 7);
        
        if (remainingCells < 7) {
            for (let i = 1; i <= remainingCells; i++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day-cell other-month';
                const dayNumber = document.createElement('span');
                dayNumber.className = 'day-number';
                dayNumber.textContent = i;
                dayCell.appendChild(dayNumber);
                calendarGrid.appendChild(dayCell);
            }
        }
        
        // ÎßàÏßÄÎßâÏóê Ï¥ù Ìñâ Í∞úÏàò Í≥ÑÏÇ∞
        const totalRows = Math.ceil((calendarGrid.children.length - 7) / 7); // ÏöîÏùº ÎùºÎ≤® Ï†úÏô∏
        
        // ÎèôÏ†ÅÏúºÎ°ú grid-template-rows ÏÑ§Ï†ï
        calendarGrid.style.gridTemplateRows = `auto repeat(${totalRows}, 1fr)`;
    }

    function selectDay(dateString) {
        if (!dailyEventsList) return;

        document.querySelectorAll('.calendar-day-cell.selected').forEach(cell => {
            cell.classList.remove('selected');
        });

        const selectedCell = document.querySelector(`.calendar-day-cell[data-date="${dateString}"]`);
        if (selectedCell) {
            selectedCell.classList.add('selected');
        }
        
        const [year, month, day] = dateString.split('-').map(Number);
        selectedDate = new Date(year, month - 1, day);
        const dayEvents = getEventsForDate(selectedDate);
        
        if (dailyEventsTitle) {
            dailyEventsTitle.textContent = `${selectedDate.toLocaleDateString('ko-KR', { month: 'long', day: 'numeric', weekday: 'short' })}Ïùò ÏùºÏ†ï`;
        }
        
        if (dailyEventsContent) {
            dailyEventsContent.innerHTML = '';
            
            const meetings = dayEvents.filter(e => e.type === 'meeting' || e.type === 'important');
            const todos = dayEvents.filter(e => e.type === 'personal');

            const typeOrder = { 'important': 1, 'meeting': 2 };
            meetings.sort((a, b) => (typeOrder[a.type] || 3) - (typeOrder[b.type] || 3));

            const meetingSection = document.createElement('div');
            meetingSection.className = 'daily-events-section';
            meetingSection.innerHTML = '<div class="daily-events-section-title">ÌöåÏùò</div>';
            
            const meetingList = document.createElement('div');
            meetingList.className = 'daily-events-list';
            
            if (meetings.length === 0) {
                meetingList.innerHTML = '<p class="cell-secondary" style="text-align: center; padding: 16px;">Îì±Î°ùÎêú ÌöåÏùòÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>';
            } else {
                meetings.forEach(event => {
                    const eventItem = document.createElement('div');
                    eventItem.className = `daily-event-item type-${event.type}`;
                    
                    let time = 'Ï¢ÖÏùº';
                    if (event.title.includes('ÌöåÏùò')) {
                        time = '10:00';
                    } else if (event.title.includes('ÎßàÍ∞ê')) {
                        time = '18:00';
                    }
                    
                    eventItem.innerHTML = `
                        <div class="event-time">${time}</div>
                        <div class="event-details">
                            <div class="event-title">${event.title}</div>
                            <div class="event-meta">${event.type === 'meeting' ? 'ÌåÄ ÌöåÏùò' : 'Ï§ëÏöî'}</div>
                        </div>
                    `;
                    meetingList.appendChild(eventItem);
                });
            }
            
            meetingSection.appendChild(meetingList);
            
            // selectDay Ìï®Ïàò ÎÇ¥Î∂ÄÏùò To-do ÏÑπÏÖò
            const todoSection = document.createElement('div');
            todoSection.className = 'daily-events-section';
            todoSection.innerHTML = '<div class="daily-events-section-title">To-do</div>';

            const todoList = document.createElement('div');
            todoList.className = 'daily-events-list';

            if (todos.length === 0) {
                todoList.innerHTML = '<p class="cell-secondary" style="text-align: center; padding: 16px;">Îì±Î°ùÎêú Ìï† ÏùºÏù¥ ÏóÜÏäµÎãàÎã§.</p>';
            } else {
                todos.forEach(event => {
                    // todos Î∞∞Ïó¥ÏóêÏÑú completed ÏÉÅÌÉú ÌôïÏù∏
                    const selectedDateString = formatDateString(selectedDate);
                    const matchedTodo = window.todos.find(t => 
                        t.title === event.title && 
                        formatDateString(new Date(t.date)) === selectedDateString
                    );
                    const isCompleted = matchedTodo ? matchedTodo.completed : false;
                    
                    const eventItem = document.createElement('div');
                    eventItem.className = `daily-event-item type-${event.type} ${isCompleted ? 'completed' : ''}`;
                    
                    let time = 'Ï¢ÖÏùº';
                    if (event.title.includes('ÌïôÏäµ')) {
                        time = '14:00';
                    }
                    
                    eventItem.innerHTML = `
                        <div class="event-time">${time}</div>
                        <div class="event-details">
                            <div class="event-title" style="${isCompleted ? 'text-decoration: line-through; color: #9ca3af;' : ''}">${event.title}</div>
                            <div class="event-meta">Í∞úÏù∏${isCompleted ? ' ‚Ä¢ ÏôÑÎ£å' : ''}</div>
                        </div>
                    `;
                    todoList.appendChild(eventItem);
                });
            }
            
            todoSection.appendChild(todoList);
            
            dailyEventsContent.appendChild(meetingSection);
            dailyEventsContent.appendChild(todoSection);
        }

        dailyEventsList.classList.remove('hidden');

        renderTodoList();  // Ïö∞Ï∏° TODO Ïπ¥Îìú ÏóÖÎç∞Ïù¥Ìä∏
        renderMeetingList(); // Ïö∞Ï∏° ÌöåÏùò Ïπ¥ÎìúÎèÑ ÏóÖÎç∞Ïù¥Ìä∏ (ÌïÑÏöîÏãú)
    }

    window.closeDailyEvents = function() {
        if (dailyEventsList) {
            dailyEventsList.classList.add('hidden');
        }
        document.querySelectorAll('.calendar-day-cell.selected').forEach(cell => {
            cell.classList.remove('selected');
        });
    }

    function changeMonth(direction) {
        currentMonth += direction;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        } else if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        renderCalendar();
        if (dailyEventsList) {
            dailyEventsList.classList.add('hidden');
        }
    }

    function renderMeetingList() {
        if (!meetingListEl) return;

        // selectedDate ÏÇ¨Ïö© (todayOnlyDate ‚Üí selectedDate)
        const formattedDate = selectedDate.toLocaleDateString('ko-KR', { month: 'long', day: 'numeric'});
        if (meetingCardTitleContentEl) {
            meetingCardTitleContentEl.textContent = `${formattedDate}Ïùò ÌöåÏùò`;
        }

        // ÏÑ†ÌÉùÎêú ÎÇ†ÏßúÏùò Ïù¥Î≤§Ìä∏ Í∞ÄÏ†∏Ïò§Í∏∞
        const selectedEvents = getEventsForDate(selectedDate);
        const meetings = selectedEvents.filter(event => event.type === 'meeting' || event.type === 'important');

        const typeOrder = { 'important': 1, 'meeting': 2 };
        meetings.sort((a, b) => {
            return (typeOrder[a.type] || 3) - (typeOrder[b.type] || 3);
        });

        meetingListEl.innerHTML = '';

        if (meetings.length === 0) {
            meetingListEl.innerHTML = '<p class="cell-secondary" style="text-align: center; padding: 16px 0;">ÌöåÏùòÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>';
            if (meetingCountEl) {
                meetingCountEl.textContent = `(Ï¥ù 0Í∞ú)`;
            }
            return;
        }

        meetings.forEach(item => {
            const meetingItem = document.createElement('div');
            meetingItem.className = 'meeting-item';
            meetingItem.innerHTML = `
                <span class="meeting-item-dot event-type-${item.type}"></span>
                <span class="meeting-item-text">${item.title}</span>
            `;
            meetingListEl.appendChild(meetingItem);
        });

        if (meetingCountEl) {
            meetingCountEl.textContent = `(Ï¥ù ${meetings.length}Í∞ú)`;
        }
    }

    function renderTodoList() {
    if (!todoListEl) return;

    // ÏÑ†ÌÉùÎêú ÎÇ†Ïßú ÏÇ¨Ïö©
    const formattedDate = selectedDate.toLocaleDateString('ko-KR', { month: 'long', day: 'numeric'});
    if (todoCardTitleContentEl) {
        todoCardTitleContentEl.textContent = `${formattedDate}Ïùò To-do`;
    }

    // ÏÑ†ÌÉùÎêú ÎÇ†ÏßúÏùò Ïù¥Î≤§Ìä∏ Í∞ÄÏ†∏Ïò§Í∏∞
    const selectedEvents = getEventsForDate(selectedDate);
    const personalEvents = selectedEvents.filter(event => event.type === 'personal');

    // ÏÑ†ÌÉùÎêú ÎÇ†ÏßúÏùò TODOÎßå ÌïÑÌÑ∞ÎßÅ
    const selectedDateString = formatDateString(selectedDate);
    const selectedTodos = todos.filter(t => {
        const todoDateString = formatDateString(new Date(t.date));
        return todoDateString === selectedDateString;
    });

    const combinedTodos = [
        ...personalEvents,
        ...selectedTodos.map(t => ({ title: t.title, type: t.type }))
    ];

    const uniqueTitles = new Set();
    let finalTodos = [];
    combinedTodos.forEach(item => {
        if (!uniqueTitles.has(item.title)) {
            uniqueTitles.add(item.title);
            finalTodos.push(item);
        }
    });

    todoListEl.innerHTML = '';

    if (finalTodos.length === 0) {
        todoListEl.innerHTML = '<p class="cell-secondary" style="text-align: center; padding: 16px 0;">Îì±Î°ùÎêú Ìï† ÏùºÏù¥ ÏóÜÏäµÎãàÎã§.</p>';
        if (todoCountEl) {
            todoCountEl.textContent = `(Ï¥ù 0Í∞ú)`;
        }
        return;
    }

    finalTodos.forEach(item => {
        const todoItem = document.createElement('div');
        todoItem.className = 'todo-item';
        todoItem.innerHTML = `
            <span class="todo-item-dot event-type-${item.type}"></span>
            <span class="todo-item-text">${item.title}</span>
        `;
        todoListEl.appendChild(todoItem);
    });

    if (todoCountEl) {
        todoCountEl.textContent = `(Ï¥ù ${finalTodos.length}Í∞ú)`;
    }
}

    // addTodo Ìï®ÏàòÎèÑ ÏàòÏ†ï - ÏÑ†ÌÉùÌïú ÎÇ†ÏßúÏóê Ï∂îÍ∞Ä
    function addTodo() {
        if (!todoInput) return;

        const title = todoInput.value.trim();
        if (title) {
            events.push({ 
                date: selectedDate,
                title: title, 
                type: "personal"
            });
            
            todos.push({
                date: selectedDate,
                title: title,
                type: "personal",
                completed: false // Í∏∞Î≥∏Í∞í false
            });
            
            window.todos = todos; // Ï†ÑÏó≠ ÏóÖÎç∞Ïù¥Ìä∏

            saveEventsToStorage(events);
            saveTodosToStorage(todos);

            todoInput.value = '';
            renderMeetingList();
            renderTodoList();
            renderCalendar();

            // ÌåùÏóÖÎèÑ Îã§Ïãú Î†åÎçîÎßÅ (Ï∂îÍ∞ÄÎêú TODOÍ∞Ä ÌåùÏóÖÏóêÎèÑ ÌëúÏãúÎê®)
            const selectedString = formatDateString(selectedDate);
            selectDay(selectedString);
        }
    }

    if (prevMonthBtn) {
        prevMonthBtn.addEventListener('click', () => changeMonth(-1));
    }
    if (nextMonthBtn) {
        nextMonthBtn.addEventListener('click', () => changeMonth(1));
    }
    if (addTodoBtn) {
        addTodoBtn.addEventListener('click', addTodo);
    }
    if (todoInput) {
        todoInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addTodo();
            }
        });
    }

    // Ï¥àÍ∏∞ Î†åÎçîÎßÅ
    renderCalendar();
    renderMeetingList();
    renderTodoList();
}

// ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCalendar);
} else {
    initCalendar();
}